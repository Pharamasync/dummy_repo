{% extends "layout.html" %}

	{% block content %}
	<style>
		.tab {
		  overflow: hidden;
		  border: 1px solid #ccc;
		  background-color: #f1f1f1;
		}

		/* Style the buttons that are used to open the tab content */
		.tab button {
		  background-color: inherit;
		  float: left;
		  border: none;
		  outline: none;
		  cursor: pointer;
		  padding: 14px 16px;
		  transition: 0.3s;
		}

		/* Change background color of buttons on hover */
		.tab button:hover {
		  background-color: #ddd;
		}

		/* Create an active/current tablink class */
		.tab button.active {
		  background-color: #ccc;
		  color: black;
		}

		/* Style the tab content */
		.tabcontent {
		  display: none;
		  padding: 6px 12px;
		  border: 1px solid #ccc;
		  border-top: none;
		}
	</style>
		<div class="adminx-main-content" >
					
			<div class="row" id="inputrow">
				<div class="col-lg-5">
					<div class="card mb-grid">
						<div class="card-header" style="background-color:#5397d3">
							<b><font color='white'>Model and Data</font></b>
						</div>
						<div class="card-body" style="background-color:#9acfff; height:500px;">
							
							<div class="form-group row">
								<label for="file_selected" class="col-sm-4 col-form-label form-label">Select Train Data</label>
								<div class="col-sm-8">
									<select name="files" onchange= "getTrainColumns(this.value); enableRunButton();getEventRate();" id="train_file_selected" class="form-control js-example-basic-single">
									<option> </option>
										{% for filename in train_file_names %}
											<option value= "{{filename }}" > {{filename }} </option>
										{% endfor %}
									</select>								  
								</div>								
							</div>
							<div class="form-group row">
								<label for="file_selected" class="col-sm-4 col-form-label form-label">Select Test Data</label>
								<div class="col-sm-8">
									<select name="files" onchange= "enableRunButton();getEventRate();" id="test_file_selected" class="form-control js-example-basic-single">
									<option> </option>
										{% for filename in test_file_names %}
											<option value= "{{filename }}" > {{filename }} </option>
										{% endfor %}
									</select>								  
								</div>								
							</div>							
							<div class="form-group row">
								<label for="file_selected" class="col-sm-4 col-form-label form-label">Target Variable</label>
								<div class="col-sm-8">
									<select name="files" onchange= "enableRunButton();getEventRate();" id="target_field" disabled class="form-control js-example-basic-single">
									<option> </option>
										{% for column in column_names %}
											<option value= "{{column }}" > {{column }} </option>
										{% endfor %}
									</select>								  
								</div>								
							</div>
							<div class="form-group row">
								<label for="model_list" class="col-sm-4 col-form-label form-label">Detection Rate</label>
								
								<div class="col-sm-8">
									<select name="detection_rate_to_select" onchange="enableRunButton();" id="detection_rate" class="form-control js-example-basic-single">
										
										{% for m in detection_list %}
											<option value= "{{m}}" > {{m}} </option>
										{% endfor %}
									</select>											
								</div>								
							</div>								
							
							<div class="form-group row">
								<label for="model_list" class="col-sm-4 col-form-label form-label">Model</label>
								
								<div class="col-sm-8">
									<select name="model_list_to_select" onchange="openForm();enableRunButton();" id="model_list" class="form-control js-example-basic-single">
										<option> </option>
										{% for m in model_list %}
											<option value= "{{m}}" > {{m}} </option>
										{% endfor %}
									</select>											
								</div>								
							</div>						
							<div class="form-group row" id="model_paramter" style="display:none">
								<div  id ='lr_model_configuration' style="display:none">
									
									<label for="file_selected" class="col-sm-12 col-form-label form-label">Model Parameters :</label>
									
									
									<label for="select_lr_solver" class="col-sm-4 col-form-label form-label">Solver</label>
									
										<select name="lr_solver"  class="col-sm-8" style="width:150px;" id="select_lr_solver" class="form-control js-example-basic-single">
											{% for s in lr_solver %}
												<option value= "{{s}}" > {{s}} </option>
											{% endfor %}
										</select>							  
									
								
								</div>
								<div  id ='dt_model_configuration' style="display:none">
									
									<label for="file_selected" class="col-sm-12 col-form-label form-label">Model Parameters :</label>
									
									
									<label for="select_dt_depth" class="col-sm-3 col-form-label form-label">Depth</label>
									
									<select name="dt_depth_select" class="col-sm-3" style ="width:80px" id="select_dt_depth" class="form-control js-example-basic-single">
										{% for depth in dt_depth %}
											<option value= "{{depth }}" > {{depth }} </option>
										{% endfor %}
									</select>
									
									<label for="select_dt_leaf" class="col-sm-3 col-form-label form-label">Leaf</label>
									
									<select name="dt_leaf_select" class="col-sm-3" style ="width:80px" id="select_dt_leaf" class="form-control js-example-basic-single">
										{% for leaf in dt_leaf %}
											<option value= "{{leaf }}" > {{leaf }} </option>
										{% endfor %}
									</select>
									
								
									
								</div>
								<div  id ='rf_model_configuration' style="display:none">
									
										<label for="file_selected" class="col-sm-12 col-form-label form-label">Model Parameters :</label>
										<label for="select_rf_trees" class="col-sm-3 col-form-label form-label">No of Trees</label>
									
										<select name="rf_trees_select" class="col-sm-3" style ="width:100px" id="select_rf_trees" class="form-control js-example-basic-single">
											{% for trees in rf_no_of_trees %}
												<option value= "{{trees }}" > {{trees }} </option>
											{% endfor %}
										</select>
										
										<label for="select_rf_min_split" class="col-sm-3 col-form-label form-label">Minimum Splits</label>
										
										<select name="rf_min_split_select" class="col-sm-3" style ="width:100px" id="select_rf_min_split" class="form-control js-example-basic-single">
											{% for split in rf_minimum_splits %}
												<option value= "{{split }}" > {{split }} </option>
											{% endfor %}
										</select>
										
									
									
										<label for="select_rf_min_leaf" class="col-sm-3 col-form-label form-label">Minimum Leaf</label>
									
											<select name="rf_min_leaf_select" class="col-sm-3" style ="width:100px" id="select_rf_min_leaf" class="form-control js-example-basic-single">
												{% for leaf in rf_minimum_leaf %}
													<option value= "{{leaf }}" > {{leaf }} </option>
												{% endfor %}
											</select>							  
									
										<label for="select_rf_bootstrap" class="col-sm-3 col-form-label form-label">Bootstrap</label>
									
											<select name="rf_bootstrap_select" class="col-sm-3" style ="width:100px" id="rf_bootstrap_select" class="form-control js-example-basic-single">
												{% for boots in rf_bootstrap %}
													<option value= "{{boots }}" > {{boots }} </option>
												{% endfor %}
											</select>
									
									</div>								
									
								</div>
								<button type="button" style= "margin-left :40%"  class="btn btn-primary btn-sm" id = "run_button">Execute</button>	
							</div>
							
							
						</div>
					</div>
					<div class="col-lg-7"  id="event_section" style="display:none">
						<div class="card mb-grid"  >
							<div class="card-header" style="background-color:#5397d3">
								<b><font color='white'>Event Rate</font></b>
							</div>
							
							  <div class="card-body" id="event_rate"  style="height:500px;" >

									<img id="display_event_image">
							  </div>
							
						</div>
					</div>
				</div>

			
					
			<div class="row" id="output_row_highlights" style="display:none" >

			<div class="col-lg-7 d-flex">
					<div class="card mb-grid w-100">
							  <div class="card-header" style="background-color: rgb(0, 102, 0);">
								<b><font color='white'>Actual vs Predicted ML Activity</font></b>
							  </div>
							  <div class="tab">
								  <button class="tablinks active" onclick="showImage(event,'CM')">Predicted vs Actual Matrix</button>
								  <button class="tablinks" id = "roc_auc" onclick="showImage(event,'AUC')">ROC AUC</button>
								  <button class="tablinks" onclick="showImage(event,'PR')">Productivity Gain</button>
								  <button class="tablinks" onclick="showImage(event,'ML')">False Positive</button>
							  </div>
							  <div class="card-body "  id="CM">	
									<img class="mb-2 mw-100 w-100 rounded" id="display_cm_image">
							  </div>
							  <div class="card-body "  id="AUC" style='display:none'>	
									<img class="mb-2 mw-100 w-100 rounded" id="display_auc_image">
							  </div>							  
							  <div class="card-body "  id="PR" style='display:none'>	
									<img class="mb-2 mw-100 w-100 rounded" id="display_pr_image">
							  </div>
							  <div class="card-body "  id="ML" style='display:none'>	
									<img class="mb-2 mw-100 w-100 rounded" id="display_ml_image">
							  </div>
							  
						</div>
			  </div>					  

				
	
				<div class="col-lg-4 d-flex">
					
					<div class="card ">
							<div class="card-header" style="background-color: rgb(0, 0, 102);"><b><font color='white'>Model Performance</font></b></div>
						

						  
						  <div class="card " style="padding-bottom:15px;" >
								<div class="card text-white bg-success" style="height:120px;">
									<div class="card-body">
									  <div class="card-body-icon" style="text-align: center">
										<div>
											<h2 id="sensitivity_bar"  style="float:left; position:absolute;"></h2>
										</div>
										<div>
											<h6 style="float:left;position: relative;top:45px;  ">Events Captured</h6>
										</div>
										<i class="fa fa-calculator fa-5x " style="float:right"></i>
									  </div>
									</div>
								</div>
							</div>
						  
						  <div class="card " style="padding-bottom:15px;" >
								<div class="card text-white bg-info" style="height:120px;">
									<div class="card-body">
									  <div class="card-body-icon" style="text-align: center">
									  
										<div>
											<h2 id="specificity_bar"  style="float:left; position:absolute;"></h2>
										</div>
										<div>
											<h6 style="float:left;position: relative;top:45px; ">Non Events Captured</h6>
										</div>
										
										<i class="fa fa-bar-chart fa-5x " style="float:right"></i>
									  </div>
									</div>
								</div>
							</div>

						  <div class="card " style="padding-bottom:15px;" >
								<div class="card text-white bg-secondary" style="height:120px;">
									<div class="card-body">
									  <div class="card-body-icon" style="text-align: center">
										<div>
											<h2 id="false_positive_bar"  style="float:left; position:absolute;"></h2>
										</div>
										<div>
											<h6 style="float:left;position: relative;top:45px;  ">False Positive Ratio</h6>
										</div>
										<i class="fa fa-pie-chart fa-5x " style="float:right"></i>
									  
								
									  </div>
									</div>
								</div>
							</div>							
							
						  <div class="card " style="padding-bottom:15px;" >
								<div class="card text-white bg-warning" style="height:120px;">
									<div class="card-body">
									  <div class="card-body-icon" style="text-align: center">
										<div>
											<h2 id="accuracy_bar"  style="float:left; position:absolute;"></h2>
										</div>
										<div>
											<h6 style="float:left;position: relative;top:45px;  ">Accuracy</h6>
										</div>
										<i class="fa fa-line-chart fa-5x " style="float:right"></i>
									  
									  </div>
									</div>
								</div>
							</div>	

							<div class="card " style="padding-bottom:15px;" >
								<div class="card text-white bg-primary" style="height:120px;">
									<div class="card-body">
									  <div class="card-body-icon" style="text-align: center">
										<i class="fa fa-area-chart fa-5x " style="float:right;"></i>
										<div>
											<h2 id="predicted_fraud_bar"  style="float:left; position:absolute;"></h2>
										</div>
										<div>
											<h6 style="float:left;position: relative;">Total no of Customers predicted as Events</h6>
										</div>
										
									  </div>
									</div>
								</div>
							</div>	
							
					</div>
					
				</div>				
			</div>
			
			<div class="row" id="output_row_tables" style="display:none">
			    <div class="col-lg-7 d-flex">
					<div class="card mb-grid w-100">
						
							<div class="card" >
								<div class="card-header d-flex justify-content-between align-items-center" style="background-color: rgb(102, 0, 0);">
									<b><font color='white'>Model Metrics</font></b>
								</div>
								
							  
							  <div class="card-body collapse show" id="card1" style="height:150px;overflow-y:auto; overflow-x:auto">
									<table id="model_output_table" class="table table-actions table-bordered table-hover mb-0">
									</table>
							  </div>
							</div>
						
					</div>
				</div>	
			</div>
			
		</div>

	{% endblock content %}

	

	{% block my_scripts %}

<script>

	$('#run_button').hide();
	$('#event_section').hide();
	
	$(document).ready(function () {
		$('#model_list').select2({
			placeholder: "Select Model",
			allowClear: true
		});
		});

	$(document).ready(function () {
		$('#train_file_selected').select2({
			placeholder: "Select Dataset",
			allowClear: true
		});
		});

	$(document).ready(function () {
		$('#test_file_selected').select2({
			placeholder: "Select Dataset",
			allowClear: true
		});
		});

function showImage(evt, type_of_image){

	if (type_of_image =='CM'){
		$('#PR').hide();
		$('#ML').hide();
		$('#CM').show();
		$('#AUC').hide();
	}else if (type_of_image =='PR'){
		$('#CM').hide();
		$('#ML').hide();
		$('#PR').show();
		$('#AUC').hide();
	}else if (type_of_image =='ML'){
		$('#CM').hide();
		$('#PR').hide();
		$('#ML').show();
		$('#AUC').hide();
	}else if (type_of_image =='AUC'){
		$('#CM').hide();
		$('#ML').hide();
		$('#PR').hide();
		$('#AUC').show();
	}

	tablinks = document.getElementsByClassName("tablinks");
	for (i = 0; i < tablinks.length; i++) {
		tablinks[i].className = tablinks[i].className.replace(" active", "");
	}	
	evt.currentTarget.className += " active";
}		
		
		
function getEventRate(){

	train_file_name= $('#train_file_selected').val();
	test_file_name= $('#test_file_selected').val();
	target =$('#target_field').val();
	
	if (train_file_name ==''  || test_file_name ==''  ||  target ==''){
		return ;
	}
	
	$.getJSON('/getModelEventRate', 
	 {
		train_file_name: train_file_name,
		test_file_name: test_file_name,
		target : target,
	  }, function(data) {
			if(data.error=='none')
			{
				console.log(data);
				$('#event_section').show();
				
				$('#display_event_image').attr('src',data.image_ui_name);
				
					
			}
			else
			{
				console.log("error");
			}
	  }
	  );	

}		
		
function getTrainColumns(filename){

	if (filename ==''){
		return ;
	}
	
	if (filename != ''){
		$('#target_field').attr("disabled", false);
	}else if (filename ==''){
		$('#target_field').attr("disabled", true);
		return;
	}
	
	
	$('#output_row_highlights').hide();
	$('#output_row_tables').hide();
	$('#output_row_graphs').hide();	
	$('#event_section').hide();

	$.getJSON('/getTrainColumnNames', 
	 {
		filename: filename,
	  }, function(data) {
			if(data.error=='none')
			{
				$('#target_field').append( new Option ('Select', 'Select',false, false));
				
				for (var i=0, len=data.all_columns.length; i<len;i++) {
				
				$('#target_field').append( new Option (data.all_columns[i], data.all_columns[i],false, false));
				}

				
			}
			else
			{
				console.log("error");
			}
	  }
	  );

}		



</script>
	
	<script>
		function openForm() {
			console.log("Open Form Clicked");
			var el = document.getElementById("model_list");
			var value = el.options[el.selectedIndex].value;
			if(value == 'Model_1(LR)')
			{
				$('#model_paramter').show();
				$('#lr_model_configuration').show();
				$('#dt_model_configuration').hide();
				$('#rf_model_configuration').hide();

				
			}				
			else if(value == 'Model_2(DT)')
			{
				$('#model_paramter').show();
				$('#lr_model_configuration').hide();
				$('#dt_model_configuration').show();
				$('#rf_model_configuration').hide();
				
			}				
			else if(value == 'Model_3(RF)')
			{
				$('#model_paramter').show();
				$('#lr_model_configuration').hide();
				$('#dt_model_configuration').hide();
				$('#rf_model_configuration').show();
				
			}
			else {
				$('#lr_model_configuration').hide();
				$('#dt_model_configuration').hide();
				$('#rf_model_configuration').hide();
			}
			
		}

	function enableRunButton(){
	
	f1 = $('#train_file_selected').val();
	f2 = $('#test_file_selected').val();
	m = $('#model_list').val();
	d = $('#detection_rate').val();
	t = $('#target_field').val();
	if (f1 != '' && f2 !='' && m != '' && t != '' && d !='') 
			$('#run_button').show();
		
	}
		
		
		
	</script>
	


	
	<script type=text/javascript>
		  $(function() 
		  {
			$('#run_button').bind('click', function() 
			{
				$('#output_row_highlights').hide();
				$('#output_row_tables').hide();
				$('#output_row_graphs').hide();
				
				$.getJSON('/run_model', 
				{				
					model : $('select[name="model_list_to_select"]').val(),
					train_file_name: $('#train_file_selected').val(),
					test_file_name: $('#test_file_selected').val(),
					lr_solver:$('select[id="select_lr_solver"]').val(),
					dt_depth : $('select[name="dt_depth_select"]').val(),
					dt_leaf : $('select[name="dt_leaf_select"]').val(),
					rf_trees : $('select[name="rf_trees_select"]').val(),
					rf_min_splits : $('select[name="rf_min_split_select"]').val(),
					rf_min_leaf : $('select[name="rf_min_leaf_select"]').val(),
					rf_bootstrap : $('select[name="rf_bootstrap_select"]').val(),
					target : $('#target_field').val(),
					detection_rate :$('select[name="detection_rate_to_select"]').val(),
					
				}, function(data) {
					if(data.error=='none')
					{
						$('#output_row_highlights').css({'display':'-webkit-box','display':'-ms-flexbox','display':'flex'})
						
						$('#output_row_graphs').css({'display':'-webkit-box','display':'-ms-flexbox','display':'flex'})
						
						
						$('#model_output_table').empty();
						$('#model_output_table').append('<tr>');
						$('#model_output_table').append('<th>True Negative</th>');
						$('#model_output_table').append('<th>True Positive</th>');
						$('#model_output_table').append('<th>False Positive</th>');
						$('#model_output_table').append('<th>False Negative</th>');
						
						$('#model_output_table').append('<tr>');
						
						$('#model_output_table').append('<td>' + data.model_result.true_negative + '</td>');
						$('#model_output_table').append('<td>' + data.model_result.true_positive + '</td>');
						$('#model_output_table').append('<td>' + data.model_result.false_positive + '</td>');
						$('#model_output_table').append('<td>' + data.model_result.false_negative + '</td>');
						
						
						
						$('#sensitivity_bar').html(data.model_result.sensitivity);
						
						$('#specificity_bar').html(data.model_result.specificity );
						$('#false_positive_bar').html(data.model_result.false_positive_ratio  );
						$('#accuracy_bar').html(data.model_result.accuracy );
						$('#predicted_fraud_bar').html(data.model_result.predicted_fraud );
						
						$('#display_cm_image').attr('src',data.confusion_matrix_plot);
						$('#display_pr_image').attr('src',data.productivity_plot);
						$('#display_ml_image').attr('src',data.ml_plot);
						
						num   = ( parseInt(data.model_result.true_positive)  + parseInt(data.model_result.false_positive))
						den = ( parseInt(data.model_result.true_negative) + parseInt(data.model_result.true_positive) + parseInt(data.model_result.false_positive)  + parseInt(data.model_result.false_negative))
						
						predicted_fraud = num * 100 / den ;
						predicted_fraud = predicted_fraud.toFixed(2);
						
						predicted_fraud = predicted_fraud.toString() +'%';
						
							$('#display_auc_image').attr('src',data.auc_plot);
							$('#roc_auc').show();						
						
						
						
					}
					else
					{
						console.log("error")
					}
					
					console.log(data);
			  });
			  return false;
			  
			}
			);
		  });
	</script>

	<script>



	
	</script>	
	{% endblock my_scripts %}	